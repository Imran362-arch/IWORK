<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>Khan World ¬∑ UWORLD Qbank</title>
    <!-- Google Font Inter + fallback -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons (optional, but adds flair) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ----- RESET & BASE ----- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: #eef2f7;
            color: #1a2b3c;
            line-height: 1.5;
            padding: 16px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        .app-container {
            max-width: 1440px;
            width: 100%;
            background: white;
            border-radius: 32px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        /* ----- HEADER TABS ----- */
        .header-tabs {
            display: flex;
            background: #f8fbfe;
            border-bottom: 1px solid #dfe8f2;
            padding: 0 16px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 16px 24px;
            font-weight: 600;
            color: #4a617c;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: 0.2s;
            white-space: nowrap;
        }
        .tab.active {
            color: #1a3c5e;
            border-bottom-color: #1a3c5e;
            background: white;
        }
        .tab:hover {
            background: #e2ecf9;
        }
        /* ----- VIEWS ----- */
        .view {
            display: none;
            padding: 24px 20px;
        }
        .view.active {
            display: block;
        }
        /* ----- DASHBOARD (HOME) ----- */
        .hero {
            text-align: center;
            padding: 40px 20px 30px;
            background: linear-gradient(145deg, #ffffff, #f3f7fd);
            border-radius: 40px;
            margin-bottom: 30px;
            box-shadow: inset 0 2px 8px rgba(255,255,255,0.8), 0 10px 20px rgba(0,20,40,0.1);
        }
        .hero h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: #0f2b44;
            margin-bottom: 16px;
            line-height: 1.2;
        }
        .hero h1 span {
            background: linear-gradient(135deg, #1a3c5e, #2b5a8c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .hero p {
            font-size: 1.2rem;
            color: #3e5e7a;
            margin-bottom: 30px;
        }
        .btn-start {
            background: #1e6dc7;
            border: none;
            border-radius: 60px;
            padding: 16px 48px;
            font-weight: 700;
            font-size: 1.3rem;
            color: white;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(30,109,199,0.3);
            transition: 0.2s;
            border: 1px solid #1a5aa8;
        }
        .btn-start:hover {
            background: #1153a0;
            transform: scale(1.02);
        }
        .section-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #1a3c5e;
            margin: 40px 0 20px;
            padding-left: 8px;
            border-left: 8px solid #1e6dc7;
        }
        .subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin: 20px 0 40px;
        }
        .subject-card {
            background: white;
            border: 1px solid #dfe8f2;
            border-radius: 28px;
            padding: 24px 20px;
            transition: 0.2s;
            cursor: pointer;
            box-shadow: 0 6px 14px rgba(0,20,40,0.04);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .subject-card:hover {
            transform: translateY(-6px);
            border-color: #aac2df;
            box-shadow: 0 20px 30px rgba(0,40,80,0.1);
        }
        .subject-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            color: #1e6dc7;
        }
        .subject-card h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #0f2b44;
            margin-bottom: 8px;
        }
        .subject-card p {
            color: #5c748f;
            font-size: 0.95rem;
        }
        /* ----- SUBJECT DETAIL VIEW ----- */
        .back-btn {
            background: none;
            border: none;
            font-size: 1.1rem;
            color: #1e6dc7;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 24px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 40px;
            transition: 0.1s;
        }
        .back-btn:hover {
            background: #e2ecf9;
        }
        .subject-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .subject-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #0f2b44;
        }
        .random-subject-btn {
            background: #1e6dc7;
            border: none;
            border-radius: 40px;
            padding: 12px 32px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 6px 14px rgba(30,109,199,0.3);
            transition: 0.1s;
        }
        .random-subject-btn:hover {
            background: #1153a0;
        }
        .subtopics-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin: 30px 0;
        }
        .subtopic-btn {
            background: white;
            border: 1.5px solid #c9d8ec;
            border-radius: 40px;
            padding: 14px 28px;
            font-weight: 500;
            color: #1a3c5e;
            cursor: pointer;
            transition: 0.1s;
            font-size: 1rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
        }
        .subtopic-btn:hover {
            background: #e2ecf9;
            border-color: #95b6db;
        }
        /* ----- PRACTICE VIEW (reused, with minor responsive tweaks) ----- */
        .practice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .timer {
            background: #1a3c5e;
            color: white;
            padding: 8px 22px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1.2rem;
        }
        .bookmark-star {
            font-size: 2rem;
            cursor: pointer;
            color: #f4b740;
            background: none;
            border: none;
            width: 48px;
            height: 48px;
        }
        .qbank-container {
            display: grid;
            grid-template-columns: 220px 1fr;
            gap: 0;
            background: white;
            border-radius: 24px;
            overflow: hidden;
            border: 1px solid #dfe8f2;
        }
        .question-sidebar {
            background: #f8fbfe;
            border-right: 1px solid #dfe8f2;
            padding: 20px 12px;
        }
        .question-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .q-num-btn {
            background: white;
            border: 1px solid #c9d8ec;
            border-radius: 12px;
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .main-panel {
            padding: 24px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .choice-item {
            border: 1.5px solid #e2eaf2;
            border-radius: 20px;
            padding: 14px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 8px;
        }
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        .primary-btn, .secondary-btn {
            padding: 12px 28px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }
        .primary-btn {
            background: #1e6dc7;
            color: white;
        }
        .secondary-btn {
            background: white;
            border: 1px solid #bccde0;
            color: #2c405c;
        }
        .explanation-panel {
            background: #f6faff;
            border-radius: 24px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #dde9fb;
        }
        /* ----- BOOKMARKS & PROGRESS (cards) ----- */
        .bookmark-item, .stat-card {
            background: #f8fbfe;
            border-radius: 20px;
            padding: 18px;
            border: 1px solid #d2e0f0;
            margin-bottom: 12px;
            cursor: pointer;
            transition: 0.1s;
        }
        .bookmark-item:hover {
            background: #e2ecf9;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
        }
        /* ----- FOOTER ----- */
        .footer {
            text-align: center;
            padding: 24px 20px 16px;
            color: #5c748f;
            font-size: 0.95rem;
            border-top: 1px solid #dfe8f2;
            margin-top: 20px;
        }
        .footer i {
            color: #c93e3e;
        }
        /* ----- MODAL (unchanged, but responsive) ----- */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
        }
        .modal.hidden { display: none; }
        .modal-content {
            background: white;
            border-radius: 32px;
            padding: 28px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 30px 60px rgba(0,0,0,0.4);
        }
        .modal-content input, .modal-content select {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid #c9d8ec;
            border-radius: 30px;
            font-size: 1rem;
            margin: 8px 0 16px;
        }
        /* ----- RESPONSIVE (mobile) ----- */
        @media (max-width: 700px) {
            body { padding: 8px; }
            .hero h1 { font-size: 1.8rem; }
            .qbank-container { grid-template-columns: 1fr; }
            .question-sidebar { border-right: none; border-bottom: 1px solid #dfe8f2; }
            .main-panel { max-height: 60vh; }
            .header-tabs { justify-content: center; }
            .tab { padding: 12px 16px; }
            .subject-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 480px) {
            .hero h1 { font-size: 1.5rem; }
            .btn-start { padding: 14px 32px; font-size: 1.1rem; }
            .subject-card { padding: 16px; }
        }
    </style>
</head>
<body>
<div class="app-container">
    <!-- Header Tabs -->
    <div class="header-tabs">
        <div class="tab active" data-view="home">üè† Home</div>
        <div class="tab" data-view="bookmarks">üîñ Bookmarks</div>
        <div class="tab" data-view="progress">üìä Progress</div>
    </div>

    <!-- Home / Dashboard View -->
    <div id="homeView" class="view active">
        <div class="hero">
            <h1>Welcome to <span>Khan World</span><br>UWORLD Qbank</h1>
            <p>Master medicine with confidence</p>
            <button class="btn-start" id="scrollToSubjects">Let's Start</button>
        </div>
        <div class="section-title" id="subjects">Subjects</div>
        <div class="subject-grid" id="subjectGrid"></div>
        <div class="random-block" style="text-align: center; margin: 40px 0;">
            <button class="random-btn" id="globalRandomBtn" style="background:#1e6dc7; border:none; border-radius:60px; padding:16px 48px; color:white; font-weight:700; font-size:1.2rem; box-shadow:0 8px 16px rgba(30,109,199,0.3);">üé≤ RANDOM QUIZ (ALL)</button>
        </div>
        <div class="footer">
            Created by Imran Khan <i class="fas fa-heart" style="color:#c93e3e;"></i> üá¶üá´ Proud of Afghanistan
        </div>
    </div>

    <!-- Subject Detail View (hidden by default) -->
    <div id="subjectView" class="view">
        <button class="back-btn" id="backToHomeBtn"><i class="fas fa-arrow-left"></i> Back to Dashboard</button>
        <div class="subject-header">
            <h2 id="subjectTitle">Biochemistry</h2>
            <button class="random-subject-btn" id="subjectRandomBtn">üé≤ Random Quiz (this subject)</button>
        </div>
        <div class="subtopics-grid" id="subtopicsContainer"></div>
    </div>

    <!-- Bookmarks View -->
    <div id="bookmarksView" class="view">
        <h2 style="margin-bottom:20px;">üîñ Your Bookmarked Questions</h2>
        <div id="bookmarksList"></div>
    </div>

    <!-- Progress View -->
    <div id="progressView" class="view">
        <h2 style="margin-bottom:20px;">üìä Your Progress</h2>
        <div id="progressStats" class="stats-grid"></div>
    </div>

    <!-- Practice View (for taking quizzes) -->
    <div id="practiceView" class="view">
        <div class="practice-header">
            <div class="timer" id="timerDisplay">00:00</div>
            <button class="bookmark-star inactive" id="bookmarkToggle">‚òÜ</button>
            <button class="secondary-btn" id="exitPracticeBtn">Exit</button>
        </div>
        <div class="qbank-container" id="qbankContainer">
            <div class="question-sidebar" id="sidebar"></div>
            <div class="main-panel" id="mainPanel"></div>
        </div>
    </div>

    <!-- Setup Modal -->
    <div id="setupModal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modalTitle">Setup Quiz</h3>
            <label>Number of questions:</label>
            <input type="number" id="questionCount" min="1" value="10">
            <div class="mode-option" style="display:flex; gap:20px; margin:16px 0;">
                <label><input type="radio" name="mode" value="normal" checked> Normal (explanations)</label>
                <label><input type="radio" name="mode" value="exam"> Exam (timer, no explanations)</label>
            </div>
            <label>Time limit (minutes, exam mode only):</label>
            <input type="number" id="timerMinutes" min="1" value="60" disabled>
            <div class="modal-actions" style="display:flex; gap:12px; margin-top:24px;">
                <button class="modal-btn primary" id="startQuizBtn" style="flex:1; background:#1e6dc7; color:white; border:none; border-radius:40px; padding:12px;">Start</button>
                <button class="modal-btn secondary" id="cancelModalBtn" style="flex:1; background:white; border:1px solid #bccde0; border-radius:40px;">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    // ========== CONFIG ==========
    const GITHUB_USER = "Imran362-arch";
    const REPO_NAME = "IWORK";
    const BASE_URL = `https://raw.githubusercontent.com/${GITHUB_USER}/${REPO_NAME}/main/`;

    const CONFIG = {
        categories: [
            {
                name: "Biochemistry",
                icon: "üß¨",
                subtopics: [
                    { name: "Cellular & Molecular", file: "data/biochemistry/cell_molecular.json" },
                    { name: "Miscellaneous", file: "data/biochemistry/miscellaneous.json" }
                ]
            },
            {
                name: "Microbiology",
                icon: "ü¶†",
                subtopics: [
                    { name: "Parasitology", file: "data/microbiology/parasitology.json" }
                ]
            }
        ]
    };

    // ========== GLOBAL STATE ==========
    let allQuestions = [];               // { id, category, subtopic, data }
    let questionsMap = new Map();
    let userAnswers = new Map();
    let submitted = new Map();
    let bookmarks = new Set();
    let currentPracticeSession = null;
    let timerInterval = null;

    // Load from localStorage
    function loadStoredData() {
        try {
            const stored = JSON.parse(localStorage.getItem('uworld_qbank'));
            if (stored) {
                userAnswers = new Map(stored.userAnswers);
                submitted = new Map(stored.submitted);
                bookmarks = new Set(stored.bookmarks || []);
            }
        } catch (e) {}
    }
    function saveStoredData() {
        localStorage.setItem('uworld_qbank', JSON.stringify({
            userAnswers: Array.from(userAnswers.entries()),
            submitted: Array.from(submitted.entries()),
            bookmarks: Array.from(bookmarks)
        }));
    }

    // ========== LOAD QUESTIONS ==========
    async function loadAllQuestions() {
        const promises = [];
        for (let cat of CONFIG.categories) {
            for (let sub of cat.subtopics) {
                const url = BASE_URL + sub.file;
                promises.push(
                    fetch(url)
                        .then(res => res.json())
                        .then(json => {
                            json.questions.forEach((q, idx) => {
                                const id = `${cat.name}_${sub.name}_${idx}`.replace(/\s+/g,'');
                                allQuestions.push({
                                    id, category: cat.name, subtopic: sub.name, data: q
                                });
                                questionsMap.set(id, q);
                            });
                        })
                        .catch(err => console.warn(`Failed to load ${sub.file}`))
                );
            }
        }
        await Promise.all(promises);
        renderDashboard();
        renderBookmarks();
        renderProgress();
    }

    // ========== DASHBOARD (subject cards) ==========
    function renderDashboard() {
        const grid = document.getElementById('subjectGrid');
        let html = '';
        CONFIG.categories.forEach(cat => {
            const count = allQuestions.filter(q => q.category === cat.name).length;
            html += `
                <div class="subject-card" data-category="${cat.name}">
                    <div class="subject-icon">${cat.icon}</div>
                    <h3>${cat.name}</h3>
                    <p>${count} questions</p>
                </div>
            `;
        });
        grid.innerHTML = html;
        document.querySelectorAll('.subject-card').forEach(card => {
            card.addEventListener('click', () => {
                const category = card.dataset.category;
                showSubjectDetail(category);
            });
        });
    }

    // ========== SUBJECT DETAIL ==========
    function showSubjectDetail(category) {
        const cat = CONFIG.categories.find(c => c.name === category);
        if (!cat) return;
        document.getElementById('subjectTitle').innerText = category;
        const subContainer = document.getElementById('subtopicsContainer');
        let html = '';
        cat.subtopics.forEach(sub => {
            const count = allQuestions.filter(q => q.category === category && q.subtopic === sub.name).length;
            html += `<button class="subtopic-btn" data-category="${category}" data-subtopic="${sub.name}">${sub.name} (${count})</button>`;
        });
        subContainer.innerHTML = html;

        // Attach subtopic click
        document.querySelectorAll('.subtopic-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const catName = btn.dataset.category;
                const subName = btn.dataset.subtopic;
                const questions = allQuestions.filter(q => q.category === catName && q.subtopic === subName).map(q => q.id);
                if (questions.length) openSetupModal(questions);
            });
        });

        // Subject random button
        document.getElementById('subjectRandomBtn').onclick = () => {
            const questions = allQuestions.filter(q => q.category === category).map(q => q.id);
            if (questions.length) openSetupModal(questions);
        };

        // Switch view
        document.querySelectorAll('.tab, .view').forEach(el => el.classList.remove('active'));
        document.getElementById('subjectView').classList.add('active');
    }

    // ========== MODAL ==========
    const modal = document.getElementById('setupModal');
    const modalTitle = document.getElementById('modalTitle');
    const questionCount = document.getElementById('questionCount');
    const modeRadios = document.getElementsByName('mode');
    const timerMinutes = document.getElementById('timerMinutes');
    let currentPool = [];

    function openSetupModal(pool) {
        currentPool = pool;
        modalTitle.innerText = `Select from ${pool.length} questions`;
        questionCount.max = pool.length;
        questionCount.value = Math.min(10, pool.length);
        modal.classList.remove('hidden');
    }

    document.getElementById('globalRandomBtn').addEventListener('click', () => {
        if (!allQuestions.length) return alert('No questions loaded.');
        openSetupModal(allQuestions.map(q => q.id));
    });

    document.getElementById('cancelModalBtn').addEventListener('click', () => modal.classList.add('hidden'));

    Array.from(modeRadios).forEach(r => r.addEventListener('change', e => {
        timerMinutes.disabled = e.target.value !== 'exam';
    }));

    document.getElementById('startQuizBtn').addEventListener('click', () => {
        const count = parseInt(questionCount.value);
        if (count < 1 || count > currentPool.length) {
            alert(`Enter between 1 and ${currentPool.length}`);
            return;
        }
        const shuffled = [...currentPool].sort(() => Math.random() - 0.5).slice(0, count);
        const mode = document.querySelector('input[name="mode"]:checked').value;
        const mins = mode === 'exam' ? parseInt(timerMinutes.value) : null;
        startPractice(shuffled, mode, mins);
        modal.classList.add('hidden');
    });

    // ========== START PRACTICE ==========
    function startPractice(questionIds, mode, timerMins) {
        if (timerInterval) clearInterval(timerInterval);
        currentPracticeSession = {
            questionIds, mode, timerMinutes: timerMins,
            startTime: Date.now(),
            timeLeft: timerMins ? timerMins * 60 : null,
            currentIndex: 0
        };
        document.querySelectorAll('.tab, .view').forEach(el => el.classList.remove('active'));
        document.getElementById('practiceView').classList.add('active');
        document.querySelector('.header-tabs').style.display = 'none';
        renderPractice();
        if (mode === 'exam') startTimer();
    }

    function startTimer() {
        if (!currentPracticeSession || currentPracticeSession.mode !== 'exam') return;
        timerInterval = setInterval(() => {
            if (!currentPracticeSession) return clearInterval(timerInterval);
            const elapsed = Math.floor((Date.now() - currentPracticeSession.startTime) / 1000);
            const total = currentPracticeSession.timerMinutes * 60;
            const left = total - elapsed;
            if (left <= 0) {
                clearInterval(timerInterval);
                alert('Time is up!');
            } else {
                currentPracticeSession.timeLeft = left;
                updateTimerDisplay();
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const left = currentPracticeSession?.timeLeft || 0;
        const mins = Math.floor(left / 60);
        const secs = left % 60;
        document.getElementById('timerDisplay').innerText = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
    }

    // ========== RENDER PRACTICE (same as before, simplified) ==========
    function renderPractice() {
        if (!currentPracticeSession) return;
        const ids = currentPracticeSession.questionIds;
        const idx = currentPracticeSession.currentIndex;
        const qid = ids[idx];
        const q = questionsMap.get(qid);
        const fullQ = allQuestions.find(qq => qq.id === qid);
        if (!q || !fullQ) return;

        const isSubmitted = submitted.get(qid) || false;
        const selected = userAnswers.get(qid);
        const correct = q.correct_choice_id;
        const letters = ['A','B','C','D','E','F'];

        // Sidebar
        let gridHtml = '<div class="question-grid">';
        for (let i = 0; i < ids.length; i++) {
            const id = ids[i];
            const status = submitted.get(id) ? (userAnswers.get(id) === questionsMap.get(id).correct_choice_id ? 'answered-correct' : 'answered-incorrect') : '';
            const current = i === idx ? 'current' : '';
            gridHtml += `<div class="q-num-btn ${status} ${current}" data-qindex="${i}">${i+1}</div>`;
        }
        gridHtml += '</div><button class="reset-all" id="resetProgressBtn" style="margin-top:16px; background:none; border:1px dashed #a7b9ce; border-radius:30px; padding:8px; width:100%;">Reset this quiz</button>';
        document.getElementById('sidebar').innerHTML = gridHtml;

        // Main
        let choicesHtml = '';
        q.choices.forEach((ch, i) => {
            let cls = 'choice-item';
            if (isSubmitted) cls += ' disabled-choice';
            if (selected === ch.id) cls += ' selected';
            if (isSubmitted && ch.id === correct) cls += ' correct-choice';
            if (isSubmitted && selected === ch.id && selected !== correct) cls += ' incorrect-selected';
            choicesHtml += `<div class="${cls}" data-choice-id="${ch.id}"><span class="choice-letter">${letters[i]}</span><span>${ch.text}</span></div>`;
        });

        const badge = isSubmitted ? (selected === correct ? '<span style="background:#1e7640; color:white; padding:4px 18px; border-radius:30px;">‚úì correct</span>' : '<span style="background:#b13e3e; color:white; padding:4px 18px; border-radius:30px;">‚úó incorrect</span>') : '';

        let explanation = '';
        if (isSubmitted && currentPracticeSession.mode !== 'exam') {
            explanation = `<div class="explanation-panel"><h3>üìò Explanation ${badge}</h3><div>${q.solution}</div></div>`;
        }

        document.getElementById('mainPanel').innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <span>Question ${idx+1}/${ids.length}</span>
                <div><button class="nav-btn" id="prevBtn" ${idx===0?'disabled':''}>‚óÄ Prev</button> <button class="nav-btn" id="nextBtn" ${idx===ids.length-1?'disabled':''}>Next ‚ñ∂</button></div>
            </div>
            <div class="question-text">${q.text}</div>
            <div class="choices-container">${choicesHtml}</div>
            <div class="action-buttons">
                <button class="primary-btn" id="submitBtn" ${isSubmitted?'disabled':''}>Submit</button>
                <button class="secondary-btn" id="clearBtn" ${!isSubmitted?'disabled':''}>Reset answer</button>
            </div>
            ${explanation}
            <footer>${fullQ.category} ¬∑ ${fullQ.subtopic}</footer>
        `;

        // Bookmark star
        const star = document.getElementById('bookmarkToggle');
        star.innerText = bookmarks.has(qid) ? '‚òÖ' : '‚òÜ';
        star.classList.toggle('active', bookmarks.has(qid));

        // Event listeners
        if (!isSubmitted) {
            document.querySelectorAll('.choice-item').forEach(el => {
                el.addEventListener('click', function() {
                    document.querySelectorAll('.choice-item').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }

        document.getElementById('submitBtn')?.addEventListener('click', () => {
            const selectedEl = document.querySelector('.choice-item.selected');
            if (!selectedEl) return alert('Select an answer');
            const choice = parseInt(selectedEl.dataset.choiceId);
            userAnswers.set(qid, choice);
            submitted.set(qid, true);
            saveStoredData();
            renderPractice();
        });

        document.getElementById('clearBtn')?.addEventListener('click', () => {
            userAnswers.delete(qid);
            submitted.delete(qid);
            saveStoredData();
            renderPractice();
        });

        document.getElementById('prevBtn')?.addEventListener('click', () => {
            if (idx > 0) { currentPracticeSession.currentIndex--; renderPractice(); }
        });
        document.getElementById('nextBtn')?.addEventListener('click', () => {
            if (idx < ids.length-1) { currentPracticeSession.currentIndex++; renderPractice(); }
        });

        document.querySelectorAll('.q-num-btn[data-qindex]').forEach(btn => {
            btn.addEventListener('click', e => {
                const i = parseInt(e.target.dataset.qindex);
                if (!isNaN(i) && i !== idx) {
                    currentPracticeSession.currentIndex = i;
                    renderPractice();
                }
            });
        });

        document.getElementById('resetProgressBtn')?.addEventListener('click', () => {
            if (confirm('Reset all answers for this quiz?')) {
                ids.forEach(id => { userAnswers.delete(id); submitted.delete(id); });
                saveStoredData();
                renderPractice();
            }
        });
    }

    // ========== BOOKMARKS ==========
    function renderBookmarks() {
        const list = document.getElementById('bookmarksList');
        if (bookmarks.size === 0) {
            list.innerHTML = '<p>No bookmarks yet. Star questions during practice.</p>';
            return;
        }
        let html = '';
        bookmarks.forEach(id => {
            const q = allQuestions.find(qq => qq.id === id);
            if (!q) return;
            html += `<div class="bookmark-item" data-id="${id}"><strong>${q.category} ¬∑ ${q.subtopic}</strong><br><small>${q.data.text.substring(0,80)}...</small></div>`;
        });
        list.innerHTML = html;
        document.querySelectorAll('.bookmark-item').forEach(el => {
            el.addEventListener('click', () => startPractice([el.dataset.id], 'normal', null));
        });
    }

    document.getElementById('bookmarkToggle')?.addEventListener('click', () => {
        if (!currentPracticeSession) return;
        const id = currentPracticeSession.questionIds[currentPracticeSession.currentIndex];
        if (bookmarks.has(id)) bookmarks.delete(id); else bookmarks.add(id);
        saveStoredData();
        renderPractice();
    });

    // ========== PROGRESS ==========
    function renderProgress() {
        const stats = {};
        allQuestions.forEach(q => {
            if (!stats[q.category]) stats[q.category] = { total:0, attempted:0, correct:0 };
            stats[q.category].total++;
            if (submitted.get(q.id)) {
                stats[q.category].attempted++;
                if (userAnswers.get(q.id) === q.data.correct_choice_id) stats[q.category].correct++;
            }
        });
        let html = '';
        for (let cat in stats) {
            const s = stats[cat];
            html += `<div class="stat-card"><h4>${cat}</h4><p>Attempted: ${s.attempted}/${s.total}</p><p>Correct: ${s.correct}</p><p>Accuracy: ${s.attempted ? ((s.correct/s.attempted)*100).toFixed(1) : 0}%</p></div>`;
        }
        document.getElementById('progressStats').innerHTML = html || '<p>No data yet.</p>';
    }

    // ========== TAB NAVIGATION ==========
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const view = tab.dataset.view;
            document.querySelectorAll('.tab, .view').forEach(el => el.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(view + 'View').classList.add('active');
            if (view === 'bookmarks') renderBookmarks();
            if (view === 'progress') renderProgress();
        });
    });

    document.getElementById('backToHomeBtn').addEventListener('click', () => {
        document.querySelectorAll('.tab, .view').forEach(el => el.classList.remove('active'));
        document.querySelector('.tab[data-view="home"]').classList.add('active');
        document.getElementById('homeView').classList.add('active');
    });

    document.getElementById('exitPracticeBtn').addEventListener('click', () => {
        if (timerInterval) clearInterval(timerInterval);
        currentPracticeSession = null;
        document.querySelector('.header-tabs').style.display = 'flex';
        document.querySelectorAll('.tab, .view').forEach(el => el.classList.remove('active'));
        document.querySelector('.tab[data-view="home"]').classList.add('active');
        document.getElementById('homeView').classList.add('active');
    });

    document.getElementById('scrollToSubjects').addEventListener('click', () => {
        document.getElementById('subjects').scrollIntoView({ behavior: 'smooth' });
    });

    // ========== INIT ==========
    loadStoredData();
    loadAllQuestions();
})();
</script>
</body>
</html>
