<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>Khan World ¬∑ UWORLD Qbank</title>
    <!-- Google Font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
    <!-- Font Awesome 6 (free) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ----- RESET & BASE ----- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: #0b1a2f;
            color: #1e2f44;
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
        }
        /* Main container */
        .master-container {
            width: 100%;
            max-width: 1440px;
            background: #ffffff;
            border-radius: 40px;
            box-shadow: 0 30px 60px rgba(0, 10, 30, 0.4);
            overflow: hidden;
            position: relative;
        }
        /* ----- LANDING PAGE (visible initially) ----- */
        .landing {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 90vh;
            background: linear-gradient(145deg, #ffffff, #f0f6ff);
            padding: 40px 24px;
            text-align: center;
            transition: opacity 0.5s ease;
        }
        .landing.hidden {
            display: none;
        }
        .landing h1 {
            font-size: clamp(2.2rem, 8vw, 4rem);
            font-weight: 800;
            background: linear-gradient(135deg, #0f2b44, #1e5a8a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 16px;
            line-height: 1.2;
        }
        .landing h1 span {
            background: linear-gradient(135deg, #b43b3b, #d4a11e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .landing .subtitle {
            font-size: 1.3rem;
            color: #3a5670;
            margin-bottom: 40px;
            max-width: 600px;
        }
        .landing .afghan {
            font-size: 1.5rem;
            margin: 20px 0 10px;
            color: #b33b3b;
        }
        .landing .afghan i {
            margin-right: 8px;
        }
        .btn-start {
            background: #1e6dc7;
            border: none;
            border-radius: 60px;
            padding: 18px 58px;
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            cursor: pointer;
            box-shadow: 0 20px 30px rgba(30,109,199,0.4);
            transition: all 0.2s;
            border: 1px solid #1358a8;
            margin-top: 30px;
        }
        .btn-start:hover {
            background: #1153a0;
            transform: scale(1.05);
            box-shadow: 0 25px 35px rgba(30,109,199,0.5);
        }
        .btn-start i {
            margin-right: 12px;
        }
        /* ----- MAIN APP (hidden initially) ----- */
        .app {
            display: none;
        }
        .app.visible {
            display: block;
        }
        /* header tabs */
        .header-tabs {
            display: flex;
            background: #f8fbfe;
            border-bottom: 2px solid #d9e4f0;
            padding: 0 20px;
            flex-wrap: wrap;
            gap: 4px;
        }
        .tab {
            padding: 18px 28px;
            font-weight: 600;
            color: #4a617c;
            cursor: pointer;
            border-bottom: 4px solid transparent;
            transition: 0.2s;
            white-space: nowrap;
            font-size: 1.1rem;
        }
        .tab.active {
            color: #1a3c5e;
            border-bottom-color: #1e6dc7;
            background: white;
        }
        .tab:hover {
            background: #e2ecf9;
        }
        /* views */
        .view {
            display: none;
            padding: 28px 24px;
        }
        .view.active {
            display: block;
        }
        /* dashboard */
        .hero {
            text-align: center;
            padding: 20px 16px 30px;
        }
        .hero h2 {
            font-size: 2.2rem;
            font-weight: 700;
            color: #0f2b44;
            margin-bottom: 20px;
        }
        .hero h2 i {
            color: #1e6dc7;
            margin-right: 12px;
        }
        .subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
            margin: 30px 0 50px;
        }
        .subject-card {
            background: white;
            border: 1px solid #dfe8f2;
            border-radius: 28px;
            padding: 28px 20px;
            transition: all 0.25s;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0,20,40,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .subject-card:hover {
            transform: translateY(-8px);
            border-color: #aac2df;
            box-shadow: 0 20px 30px rgba(0,40,80,0.15);
        }
        .subject-icon {
            font-size: 3.5rem;
            margin-bottom: 20px;
            background: #e9f0fa;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .subject-card h3 {
            font-size: 1.8rem;
            font-weight: 600;
            color: #0f2b44;
        }
        .subject-card p {
            color: #5f7a9a;
            font-size: 1.1rem;
            margin-top: 8px;
        }
        .random-global {
            text-align: center;
            margin: 30px 0;
        }
        .btn-random-global {
            background: #1e6dc7;
            border: none;
            border-radius: 60px;
            padding: 16px 48px;
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(30,109,199,0.3);
            transition: 0.2s;
        }
        .btn-random-global:hover {
            background: #1153a0;
            transform: scale(1.02);
        }
        /* subject detail */
        .back-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #1e6dc7;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            padding: 8px 20px;
            border-radius: 40px;
        }
        .back-btn:hover {
            background: #e2ecf9;
        }
        .subject-header {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }
        .subject-header h2 {
            font-size: 2.2rem;
            font-weight: 700;
            color: #0f2b44;
        }
        .btn-random-subject {
            background: #1e6dc7;
            border: none;
            border-radius: 40px;
            padding: 12px 32px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        .subtopics-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }
        .subtopic-btn {
            background: white;
            border: 2px solid #c9d8ec;
            border-radius: 50px;
            padding: 14px 30px;
            font-size: 1.1rem;
            font-weight: 500;
            color: #1a3c5e;
            cursor: pointer;
            transition: 0.1s;
        }
        .subtopic-btn:hover {
            background: #e2ecf9;
            border-color: #1e6dc7;
        }
        /* practice view */
        .practice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
        }
        .timer {
            background: #1a3c5e;
            color: white;
            padding: 8px 24px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1.2rem;
        }
        .bookmark-star {
            font-size: 2.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: #f5b342;
            transition: 0.1s;
        }
        .bookmark-star.inactive { color: #ccc; }
        .exit-btn {
            background: white;
            border: 1px solid #bccde0;
            border-radius: 40px;
            padding: 10px 28px;
            font-weight: 600;
            cursor: pointer;
        }
        .qbank-container {
            display: grid;
            grid-template-columns: 240px 1fr;
            gap: 0;
            border: 1px solid #dfe8f2;
            border-radius: 28px;
            overflow: hidden;
            background: white;
        }
        .question-sidebar {
            background: #f8fbfe;
            border-right: 1px solid #dfe8f2;
            padding: 20px 12px;
        }
        .question-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .q-num-btn {
            background: white;
            border: 1px solid #c9d8ec;
            border-radius: 12px;
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .q-num-btn.current { background: #1a3c5e; color: white; }
        .q-num-btn.answered-correct { background: #e1f7e4; border-color: #2b7a4b; }
        .q-num-btn.answered-incorrect { background: #ffeae9; border-color: #c93e3e; }
        .main-panel {
            padding: 28px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .question-text {
            font-size: 1.2rem;
            margin-bottom: 28px;
        }
        .choices-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .choice-item {
            border: 2px solid #e2eaf2;
            border-radius: 24px;
            padding: 16px 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: 0.1s;
            position: relative;
        }
        .choice-item.selected {
            border-color: #1e6dc7;
            background: #e4effb;
            box-shadow: 0 0 0 3px rgba(30,109,199,0.2);
        }
        .choice-item.selected::after {
            content: "‚úì";
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            color: #1e6dc7;
            font-weight: bold;
        }
        .choice-item.correct-choice {
            border-color: #2b7a4b;
            background: #e1f7e4;
        }
        .choice-item.incorrect-selected {
            border-color: #c93e3e;
            background: #ffeae9;
        }
        .choice-letter {
            font-weight: 700;
            background: #dbe5f1;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a3c5e;
        }
        .choice-item.selected .choice-letter {
            background: #1e6dc7;
            color: white;
        }
        .action-buttons {
            display: flex;
            gap: 16px;
            margin: 24px 0;
            flex-wrap: wrap;
        }
        .primary-btn, .secondary-btn {
            padding: 14px 36px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            border: none;
        }
        .primary-btn { background: #1e6dc7; color: white; }
        .secondary-btn { background: white; border: 1px solid #bccde0; color: #2c405c; }
        .explanation-panel {
            background: #f6faff;
            border-radius: 28px;
            padding: 28px;
            margin-top: 24px;
            border: 1px solid #dde9fb;
        }
        /* bookmarks & progress */
        .bookmark-item, .stat-card {
            background: #f8fbfe;
            border-radius: 24px;
            padding: 20px;
            border: 1px solid #d2e0f0;
            margin-bottom: 12px;
            cursor: pointer;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
        }
        /* footer */
        .app-footer {
            text-align: center;
            padding: 24px 16px 16px;
            color: #5f7a9a;
            border-top: 1px solid #dfe8f2;
            margin-top: 30px;
        }
        /* modal */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
        }
        .modal.hidden { display: none; }
        .modal-content {
            background: white;
            border-radius: 40px;
            padding: 32px;
            max-width: 420px;
            width: 100%;
        }
        .modal-content input, .modal-content select {
            width: 100%;
            padding: 14px 20px;
            border: 2px solid #c9d8ec;
            border-radius: 40px;
            margin: 10px 0 20px;
            font-size: 1rem;
        }
        .mode-option {
            display: flex;
            gap: 20px;
            margin: 16px 0;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        .modal-btn {
            flex: 1;
            padding: 14px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }
        .modal-btn.primary { background: #1e6dc7; color: white; }
        .modal-btn.secondary { background: white; border: 1px solid #bccde0; }
        /* mobile adjustments */
        @media (max-width: 700px) {
            .qbank-container { grid-template-columns: 1fr; }
            .question-sidebar { border-right: none; border-bottom: 1px solid #dfe8f2; }
            .main-panel { max-height: 60vh; }
            .header-tabs { justify-content: center; }
            .tab { padding: 14px 18px; font-size: 1rem; }
            .subject-grid { grid-template-columns: 1fr; }
            .subject-header h2 { font-size: 1.8rem; }
            .btn-start { padding: 16px 40px; font-size: 1.3rem; }
        }
        @media (max-width: 480px) {
            .landing h1 { font-size: 2rem; }
            .subtitle { font-size: 1.1rem; }
            .choice-item { padding: 12px 18px; }
            .choice-letter { width: 36px; height: 36px; }
        }
    </style>
</head>
<body>
<div class="master-container">
    <!-- LANDING PAGE (visible first) -->
    <div id="landingPage" class="landing">
        <h1>Welcome to <span>Khan World</span></h1>
        <div class="subtitle">UWORLD Qbank ¬∑ Master Medicine</div>
        <div class="afghan">
            <i class="fas fa-flag"></i> Imran Khan ¬∑ Proud of Afghanistan <i class="fas fa-heart" style="color:#c93e3e;"></i>
        </div>
        <button class="btn-start" id="startAppBtn"><i class="fas fa-play"></i> Let's Start</button>
    </div>

    <!-- MAIN APP (hidden initially) -->
    <div id="mainApp" class="app">
        <div class="header-tabs">
            <div class="tab active" data-view="home">üè† Dashboard</div>
            <div class="tab" data-view="bookmarks">üîñ Bookmarks</div>
            <div class="tab" data-view="progress">üìä Progress</div>
        </div>

        <!-- Home / Dashboard -->
        <div id="homeView" class="view active">
            <div class="hero">
                <h2><i class="fas fa-book-open"></i> Subjects</h2>
            </div>
            <div class="subject-grid" id="subjectGrid"></div>
            <div class="random-global">
                <button class="btn-random-global" id="globalRandomBtn"><i class="fas fa-dice"></i> Random Quiz (All)</button>
            </div>
            <div class="app-footer">
                <i class="fas fa-flag"></i> Imran Khan ¬∑ Proud of Afghanistan
            </div>
        </div>

        <!-- Subject Detail View (hidden) -->
        <div id="subjectView" class="view">
            <button class="back-btn" id="backToHomeBtn"><i class="fas fa-arrow-left"></i> Back to Dashboard</button>
            <div class="subject-header">
                <h2 id="subjectTitle">Biochemistry</h2>
                <button class="btn-random-subject" id="subjectRandomBtn"><i class="fas fa-dice"></i> Random Quiz (this subject)</button>
            </div>
            <div class="subtopics-grid" id="subtopicsContainer"></div>
        </div>

        <!-- Bookmarks View -->
        <div id="bookmarksView" class="view">
            <h2 style="margin-bottom:20px;"><i class="fas fa-bookmark"></i> Your Bookmarks</h2>
            <div id="bookmarksList"></div>
        </div>

        <!-- Progress View -->
        <div id="progressView" class="view">
            <h2 style="margin-bottom:20px;"><i class="fas fa-chart-line"></i> Your Progress</h2>
            <div id="progressStats" class="stats-grid"></div>
        </div>

        <!-- Practice View -->
        <div id="practiceView" class="view">
            <div class="practice-header">
                <div class="timer" id="timerDisplay">00:00</div>
                <button class="bookmark-star inactive" id="bookmarkToggle">‚òÜ</button>
                <button class="exit-btn" id="exitPracticeBtn">Exit</button>
            </div>
            <div class="qbank-container" id="qbankContainer">
                <div class="question-sidebar" id="sidebar"></div>
                <div class="main-panel" id="mainPanel"></div>
            </div>
        </div>
    </div>

    <!-- Setup Modal -->
    <div id="setupModal" class="modal hidden">
        <div class="modal-content">
            <h3><i class="fas fa-sliders-h"></i> Setup Quiz</h3>
            <label>Number of questions:</label>
            <input type="number" id="questionCount" min="1" value="10">
            <div class="mode-option">
                <label><input type="radio" name="mode" value="normal" checked> Normal (explanations)</label>
                <label><input type="radio" name="mode" value="exam"> Exam (timer, no explanations)</label>
            </div>
            <label>Time limit (minutes, exam only):</label>
            <input type="number" id="timerMinutes" min="1" value="60" disabled>
            <div class="modal-actions">
                <button class="modal-btn primary" id="startQuizBtn">Start</button>
                <button class="modal-btn secondary" id="cancelModalBtn">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    // ========== CONFIG ==========
    const GITHUB_USER = "Imran362-arch";
    const REPO_NAME = "IWORK";
    const BASE_URL = `https://raw.githubusercontent.com/${GITHUB_USER}/${REPO_NAME}/main/`;

    const CONFIG = {
        categories: [
            {
                name: "Biochemistry",
                icon: "üß¨",
                subtopics: [
                    { name: "Cellular & Molecular", file: "data/biochemistry/cell_molecular.json" },
                    { name: "Miscellaneous", file: "data/biochemistry/miscellaneous.json" }
                ]
            },
            {
                name: "Microbiology",
                icon: "ü¶†",
                subtopics: [
                    { name: "Parasitology", file: "data/microbiology/parasitology.json" }
                ]
            }
        ]
    };

    // ========== STATE ==========
    let allQuestions = [];
    let questionsMap = new Map();
    let userAnswers = new Map();
    let submitted = new Map();
    let bookmarks = new Set();
    let currentPracticeSession = null;
    let timerInterval = null;

    // Load from localStorage
    function loadStoredData() {
        try {
            const stored = JSON.parse(localStorage.getItem('uworld_qbank'));
            if (stored) {
                userAnswers = new Map(stored.userAnswers);
                submitted = new Map(stored.submitted);
                bookmarks = new Set(stored.bookmarks || []);
            }
        } catch (e) {}
    }
    function saveStoredData() {
        localStorage.setItem('uworld_qbank', JSON.stringify({
            userAnswers: Array.from(userAnswers.entries()),
            submitted: Array.from(submitted.entries()),
            bookmarks: Array.from(bookmarks)
        }));
    }

    // ========== LOAD QUESTIONS ==========
    async function loadAllQuestions() {
        const promises = [];
        for (let cat of CONFIG.categories) {
            for (let sub of cat.subtopics) {
                const url = BASE_URL + sub.file;
                promises.push(
                    fetch(url)
                        .then(res => res.json())
                        .then(json => {
                            json.questions.forEach((q, idx) => {
                                const id = `${cat.name}_${sub.name}_${idx}`.replace(/\s+/g,'');
                                allQuestions.push({
                                    id, category: cat.name, subtopic: sub.name, data: q
                                });
                                questionsMap.set(id, q);
                            });
                        })
                        .catch(err => console.warn(`Failed to load ${sub.file}`))
                );
            }
        }
        await Promise.all(promises);
        renderDashboard();
        renderBookmarks();
        renderProgress();
    }

    // ========== DASHBOARD ==========
    function renderDashboard() {
        const grid = document.getElementById('subjectGrid');
        let html = '';
        CONFIG.categories.forEach(cat => {
            const count = allQuestions.filter(q => q.category === cat.name).length;
            html += `
                <div class="subject-card" data-category="${cat.name}">
                    <div class="subject-icon">${cat.icon}</div>
                    <h3>${cat.name}</h3>
                    <p>${count} questions</p>
                </div>
            `;
        });
        grid.innerHTML = html;
        document.querySelectorAll('.subject-card').forEach(card => {
            card.addEventListener('click', () => showSubjectDetail(card.dataset.category));
        });
    }

    // ========== SUBJECT DETAIL ==========
    function showSubjectDetail(category) {
        const cat = CONFIG.categories.find(c => c.name === category);
        if (!cat) return;
        document.getElementById('subjectTitle').innerText = category;
        const subContainer = document.getElementById('subtopicsContainer');
        let html = '';
        cat.subtopics.forEach(sub => {
            const count = allQuestions.filter(q => q.category === category && q.subtopic === sub.name).length;
            html += `<button class="subtopic-btn" data-category="${category}" data-subtopic="${sub.name}">${sub.name} (${count})</button>`;
        });
        subContainer.innerHTML = html;
        document.querySelectorAll('.subtopic-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const catName = btn.dataset.category;
                const subName = btn.dataset.subtopic;
                const questions = allQuestions.filter(q => q.category === catName && q.subtopic === subName).map(q => q.id);
                if (questions.length) openSetupModal(questions);
            });
        });
        document.getElementById('subjectRandomBtn').onclick = () => {
            const questions = allQuestions.filter(q => q.category === category).map(q => q.id);
            if (questions.length) openSetupModal(questions);
        };
        document.querySelectorAll('.tab, .view').forEach(el => el.classList.remove('active'));
        document.getElementById('subjectView').classList.add('active');
    }

    // ========== MODAL ==========
    const modal = document.getElementById('setupModal');
    const modalTitle = document.getElementById('modalTitle');
    const questionCount = document.getElementById('questionCount');
    const modeRadios = document.getElementsByName('mode');
    const timerMinutes = document.getElementById('timerMinutes');
    let currentPool = [];

    function openSetupModal(pool) {
        currentPool = pool;
        modalTitle.innerText = `Select from ${pool.length} questions`;
        questionCount.max = pool.length;
        questionCount.value = Math.min(10, pool.length);
        modal.classList.remove('hidden');
    }

    document.getElementById('globalRandomBtn').addEventListener('click', () => {
        if (!allQuestions.length) return alert('No questions loaded.');
        openSetupModal(allQuestions.map(q => q.id));
    });

    document.getElementById('cancelModalBtn').addEventListener('click', () => modal.classList.add('hidden'));

    Array.from(modeRadios).forEach(r => r.addEventListener('change', e => {
        timerMinutes.disabled = e.target.value !== 'exam';
    }));

    document.getElementById('startQuizBtn').addEventListener('click', () => {
        const count = parseInt(questionCount.value);
        if (count < 1 || count > currentPool.length) {
            alert(`Enter between 1 and ${currentPool.length}`);
            return;
        }
        const shuffled = [...currentPool].sort(() => Math.random() - 0.5).slice(0, count);
        const mode = document.querySelector('input[name="mode"]:checked').value;
        const mins = mode === 'exam' ? parseInt(timerMinutes.value) : null;
        startPractice(shuffled, mode, mins);
        modal.classList.add('hidden');
    });

    // ========== START PRACTICE ==========
    function startPractice(questionIds, mode, timerMins) {
        if (timerInterval) clearInterval(timerInterval);
        currentPracticeSession = {
            questionIds, mode, timerMinutes: timerMins,
            startTime: Date.now(),
            timeLeft: timerMins ? timerMins * 60 : null,
            currentIndex: 0
        };
        document.querySelectorAll('.tab, .view').forEach(el => el.classList.remove('active'));
        document.getElementById('practiceView').classList.add('active');
        document.querySelector('.header-tabs').style.display = 'none';
        renderPractice();
        if (mode === 'exam') startTimer();
    }

    function startTimer() {
        if (!currentPracticeSession || currentPracticeSession.mode !== 'exam') return;
        timerInterval = setInterval(() => {
            if (!currentPracticeSession) return clearInterval(timerInterval);
            const elapsed = Math.floor((Date.now() - currentPracticeSession.startTime) / 1000);
            const total = currentPracticeSession.timerMinutes * 60;
            const left = total - elapsed;
            if (left <= 0) {
                clearInterval(timerInterval);
                alert('Time is up!');
            } else {
                currentPracticeSession.timeLeft = left;
                updateTimerDisplay();
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const left = currentPracticeSession?.timeLeft || 0;
        const mins = Math.floor(left / 60);
        const secs = left % 60;
        document.getElementById('timerDisplay').innerText = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
    }

    // ========== RENDER PRACTICE ==========
    function renderPractice() {
        if (!currentPracticeSession) return;
        const ids = currentPracticeSession.questionIds;
        const idx = currentPracticeSession.currentIndex;
        const qid = ids[idx];
        const q = questionsMap.get(qid);
        const fullQ = allQuestions.find(qq => qq.id === qid);
        if (!q || !fullQ) return;

        const isSubmitted = submitted.get(qid) || false;
        const selected = userAnswers.get(qid);
        const correct = q.correct_choice_id;
        const letters = ['A','B','C','D','E','F'];

        // Sidebar
        let gridHtml = '<div class="question-grid">';
        for (let i = 0; i < ids.length; i++) {
            const id = ids[i];
            const status = submitted.get(id) ? (userAnswers.get(id) === questionsMap.get(id).correct_choice_id ? 'answered-correct' : 'answered-incorrect') : '';
            const current = i === idx ? 'current' : '';
            gridHtml += `<div class="q-num-btn ${status} ${current}" data-qindex="${i}">${i+1}</div>`;
        }
        gridHtml += '</div><button class="reset-all" id="resetProgressBtn" style="margin-top:20px; background:none; border:1px dashed #a7b9ce; border-radius:30px; padding:10px; width:100%;">Reset this quiz</button>';
        document.getElementById('sidebar').innerHTML = gridHtml;

        // Main
        let choicesHtml = '';
        q.choices.forEach((ch, i) => {
            let cls = 'choice-item';
            if (isSubmitted) cls += ' disabled-choice';
            if (selected === ch.id) cls += ' selected';
            if (isSubmitted && ch.id === correct) cls += ' correct-choice';
            if (isSubmitted && selected === ch.id && selected !== correct) cls += ' incorrect-selected';
            choicesHtml += `<div class="${cls}" data-choice-id="${ch.id}"><span class="choice-letter">${letters[i]}</span><span>${ch.text}</span></div>`;
        });

        const badge = isSubmitted ? (selected === correct ? '<span style="background:#1e7640; color:white; padding:4px 18px; border-radius:30px;">‚úì correct</span>' : '<span style="background:#b13e3e; color:white; padding:4px 18px; border-radius:30px;">‚úó incorrect</span>') : '';

        let explanation = '';
        if (isSubmitted && currentPracticeSession.mode !== 'exam') {
            explanation = `<div class="explanation-panel"><h3>üìò Explanation ${badge}</h3><div>${q.solution}</div></div>`;
        }

        document.getElementById('mainPanel').innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <span>Q${idx+1}/${ids.length}</span>
                <div><button class="nav-btn" id="prevBtn" ${idx===0?'disabled':''} style="background:none; border:1px solid #bccde0; border-radius:30px; padding:8px 16px;">‚óÄ Prev</button> <button class="nav-btn" id="nextBtn" ${idx===ids.length-1?'disabled':''} style="background:none; border:1px solid #bccde0; border-radius:30px; padding:8px 16px;">Next ‚ñ∂</button></div>
            </div>
            <div class="question-text">${q.text}</div>
            <div class="choices-container">${choicesHtml}</div>
            <div class="action-buttons">
                <button class="primary-btn" id="submitBtn" ${isSubmitted?'disabled':''}>Submit</button>
                <button class="secondary-btn" id="clearBtn" ${!isSubmitted?'disabled':''}>Reset answer</button>
            </div>
            ${explanation}
            <footer style="margin-top:20px; color:#8a9bb0;">${fullQ.category} ¬∑ ${fullQ.subtopic}</footer>
        `;

        // Bookmark star
        const star = document.getElementById('bookmarkToggle');
        star.innerText = bookmarks.has(qid) ? '‚òÖ' : '‚òÜ';
        star.classList.toggle('active', bookmarks.has(qid));

        // Event listeners
        if (!isSubmitted) {
            document.querySelectorAll('.choice-item').forEach(el => {
                el.addEventListener('click', function() {
                    document.querySelectorAll('.choice-item').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }

        document.getElementById('submitBtn')?.addEventListener('click', () => {
            const selectedEl = document.querySelector('.choice-item.selected');
            if (!selectedEl) return alert('Select an answer');
            const choice = parseInt(selectedEl.dataset.choiceId);
            userAnswers.set(qid, choice);
            submitted.set(qid, true);
            saveStoredData();
            renderPractice();
        });

        document.getElementById('clearBtn')?.addEventListener('click', () => {
            userAnswers.delete(qid);
            submitted.delete(qid);
            saveStoredData();
            renderPractice();
        });

        document.getElementById('prevBtn')?.addEventListener('click', () => {
            if (idx > 0) { currentPracticeSession.currentIndex--; renderPractice(); }
        });
        document.getElementById('nextBtn')?.addEventListener('click', () => {
            if (idx < ids.length-1) { currentPracticeSession.currentIndex++; renderPractice(); }
        });

        document.querySelectorAll('.q-num-btn[data-qindex]').forEach(btn => {
            btn.addEventListener('click', e => {
                const i = parseInt(e.target.dataset.qindex);
                if (!isNaN(i) && i !== idx) {
                    currentPracticeSession.currentIndex = i;
                    renderPractice();
                }
            });
        });

        document.getElementById('resetProgressBtn')?.addEventListener('click', () => {
            if (confirm('Reset all answers for this quiz?')) {
                ids.forEach(id => { userAnswers.delete(id); submitted.delete(id); });
                saveStoredData();
                renderPractice();
            }
        });
    }

    // ========== BOOKMARKS ==========
    function renderBookmarks() {
        const list = document.getElementById('bookmarksList');
        if (bookmarks.size === 0) {
            list.innerHTML = '<p>No bookmarks yet. Star questions during practice.</p>';
            return;
        }
        let html = '';
        bookmarks.forEach(id => {
            const q = allQuestions.find(qq => qq.id === id);
            if (!q) return;
            html += `<div class="bookmark-item" data-id="${id}"><strong>${q.category} ¬∑ ${q.subtopic}</strong><br><small>${q.data.text.substring(0,80)}...</small></div>`;
        });
        list.innerHTML = html;
        document.querySelectorAll('.bookmark-item').forEach(el => {
            el.addEventListener('click', () => startPractice([el.dataset.id], 'normal', null));
        });
    }

    document.getElementById('bookmarkToggle')?.addEventListener('click', () => {
        if (!currentPracticeSession) return;
        const id = currentPracticeSession.questionIds[currentPracticeSession.currentIndex];
        if (bookmarks.has(id)) bookmarks.delete(id); else bookmarks.add(id);
        saveStoredData();
        renderPractice();
    });

    // ========== PROGRESS ==========
    function renderProgress() {
        const stats = {};
        allQuestions.forEach(q => {
            if (!stats[q.category]) stats[q.category] = { total:0, attempted:0, correct:0 };
            stats[q.category].total++;
            if (submitted.get(q.id)) {
                stats[q.category].attempted++;
                if (userAnswers.get(q.id) === q.data.correct_choice_id) stats[q.category].correct++;
            }
        });
        let html = '';
        for (let cat in stats) {
            const s = stats[cat];
            html += `<div class="stat-card"><h4>${cat}</h4><p>Attempted: ${s.attempted}/${s.total}</p><p>Correct: ${s.correct}</p><p>Accuracy: ${s.attempted ? ((s.correct/s.attempted)*100).toFixed(1) : 0}%</p></div>`;
        }
        document.getElementById('progressStats').innerHTML = html || '<p>No data yet.</p>';
    }

    // ========== TAB NAVIGATION ==========
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const view = tab.dataset.view;
            document.querySelectorAll('.tab, .view').forEach(el => el.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(view + 'View').classList.add('active');
            if (view === 'bookmarks') renderBookmarks();
            if (view === 'progress') renderProgress();
        });
    });

    document.getElementById('backToHomeBtn').addEventListener('click', () => {
        document.querySelectorAll('.tab, .view').forEach(el => el.classList.remove('active'));
        document.querySelector('.tab[data-view="home"]').classList.add('active');
        document.getElementById('homeView').classList.add('active');
    });

    document.getElementById('exitPracticeBtn').addEventListener('click', () => {
        if (timerInterval) clearInterval(timerInterval);
        currentPracticeSession = null;
        document.querySelector('.header-tabs').style.display = 'flex';
        document.querySelectorAll('.tab, .view').forEach(el => el.classList.remove('active'));
        document.querySelector('.tab[data-view="home"]').classList.add('active');
        document.getElementById('homeView').classList.add('active');
    });

    // ========== LANDING TO APP TRANSITION ==========
    document.getElementById('startAppBtn').addEventListener('click', () => {
        document.getElementById('landingPage').classList.add('hidden');
        document.getElementById('mainApp').classList.add('visible');
    });

    // ========== INIT ==========
    loadStoredData();
    loadAllQuestions();
})();
</script>
</body>
</html>
