<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UWORLD Qbank Â· Complete</title>
    <!-- Google Font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
    <style>
        /* ===== EXACT UWORLD STYLE (extended) ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: #eef2f7;
            color: #1a2b3c;
            line-height: 1.5;
            padding: 24px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }
        .app-container {
            max-width: 1440px;
            width: 100%;
            background: white;
            border-radius: 32px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        /* header tabs */
        .header-tabs {
            display: flex;
            background: #f8fbfe;
            border-bottom: 1px solid #dfe8f2;
            padding: 0 24px;
        }
        .tab {
            padding: 18px 28px;
            font-weight: 600;
            color: #4a617c;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: 0.1s;
        }
        .tab.active {
            color: #1a3c5e;
            border-bottom-color: #1a3c5e;
            background: white;
        }
        .tab:hover {
            background: #e2ecf9;
        }
        /* main content area (dynamic views) */
        .view {
            display: none;
            padding: 28px 32px;
        }
        .view.active {
            display: block;
        }
        /* home: category grid */
        .categories {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .category-card {
            border: 1px solid #dfe8f2;
            border-radius: 24px;
            background: #fafcff;
            overflow: hidden;
        }
        .category-header {
            background: #e9f0fa;
            padding: 16px 24px;
            font-weight: 700;
            font-size: 1.3rem;
            color: #1a3c5e;
        }
        .subtopics {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 20px 24px;
        }
        .subtopic-btn {
            background: white;
            border: 1.5px solid #c9d8ec;
            border-radius: 40px;
            padding: 10px 24px;
            font-weight: 500;
            color: #1a3c5e;
            cursor: pointer;
            transition: 0.1s;
            font-size: 0.95rem;
        }
        .subtopic-btn:hover {
            background: #e2ecf9;
            border-color: #95b6db;
        }
        .random-block {
            margin: 32px 0 16px;
            background: linear-gradient(145deg, #f8fbfe, #e9f0fa);
            border-radius: 24px;
            padding: 28px;
            text-align: center;
        }
        .random-btn {
            background: #1e6dc7;
            border: none;
            border-radius: 60px;
            padding: 16px 48px;
            font-weight: 700;
            font-size: 1.2rem;
            color: white;
            cursor: pointer;
            box-shadow: 0 8px 16px rgba(30,109,199,0.3);
        }
        .random-btn:hover {
            background: #1153a0;
        }
        /* modal for quiz setup */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.hidden {
            display: none;
        }
        .modal-content {
            background: white;
            border-radius: 32px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 30px 60px rgba(0,0,0,0.4);
        }
        .modal-content h3 {
            margin-bottom: 20px;
            color: #1a3c5e;
        }
        .modal-content input, .modal-content select {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid #c9d8ec;
            border-radius: 30px;
            font-size: 1rem;
            margin: 8px 0 16px;
        }
        .mode-option {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 16px 0;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }
        .modal-btn.primary {
            background: #1e6dc7;
            color: white;
        }
        .modal-btn.secondary {
            background: white;
            border: 1px solid #bccde0;
            color: #2c405c;
        }
        /* practice view (reuses original style but added bookmark) */
        .practice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .timer {
            background: #1a3c5e;
            color: white;
            padding: 8px 22px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1.2rem;
        }
        .bookmark-star {
            font-size: 2rem;
            cursor: pointer;
            color: #f4b740;
            transition: 0.1s;
            background: none;
            border: none;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .bookmark-star.active {
            color: #f4b740;
            text-shadow: 0 0 10px #ffb703;
        }
        .bookmark-star.inactive {
            color: #ccc;
        }
        /* bookmarks list */
        .bookmark-item {
            border: 1px solid #dfe8f2;
            border-radius: 20px;
            padding: 18px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: 0.1s;
        }
        .bookmark-item:hover {
            background: #f6faff;
        }
        .bookmark-item small {
            color: #647b9b;
        }
        /* progress stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px,1fr));
            gap: 16px;
            margin-top: 20px;
        }
        .stat-card {
            background: #f8fbfe;
            border-radius: 20px;
            padding: 18px;
            border: 1px solid #d2e0f0;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #647b9b;
        }
        /* existing styles for question sidebar/main (reused) */
        .qbank-container {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 0;
            background: white;
            border-radius: 24px;
            overflow: hidden;
            border: 1px solid #dfe8f2;
        }
        .question-sidebar { background: #f8fbfe; border-right: 1px solid #dfe8f2; padding: 28px 16px; }
        .question-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin-bottom: 30px; }
        .q-num-btn { background: white; border:1px solid #c9d8ec; border-radius:14px; aspect-ratio:1; display:flex; align-items:center; justify-content:center; font-weight:600; cursor:pointer; }
        .q-num-btn.current { background:#1a3c5e; color:white; }
        .q-num-btn.answered-correct { background:#e1f7e4; border-color:#2b7a4b; }
        .q-num-btn.answered-incorrect { background:#ffeae9; border-color:#c93e3e; }
        .main-panel { padding: 36px 42px; max-height: 70vh; overflow-y: auto; }
        .question-text { font-size:1.2rem; margin-bottom:28px; }
        .choices-container { display:flex; flex-direction:column; gap:12px; }
        .choice-item { border:1.5px solid #e2eaf2; border-radius:20px; padding:16px 24px; cursor:pointer; display:flex; gap:18px; }
        .choice-item.selected { background:#e4effb; border-color:#1e6dc7; }
        .choice-item.correct-choice { border-color:#2b7a4b; background:#e1f7e4; }
        .choice-item.incorrect-selected { border-color:#c93e3e; background:#ffeae9; }
        .disabled-choice { pointer-events:none; }
        .action-buttons { display:flex; gap:14px; margin:24px 0; }
        .primary-btn { background:#1e6dc7; border:none; border-radius:40px; padding:14px 38px; color:white; font-weight:600; cursor:pointer; }
        .secondary-btn { background:white; border:1px solid #bccde0; border-radius:40px; padding:14px 28px; cursor:pointer; }
        .explanation-panel { background:#f6faff; border-radius:28px; padding:28px 32px; margin-top:24px; border:1px solid #dde9fb; }
        footer { text-align:right; color:#8a9bb0; font-size:0.8rem; margin-top:30px; }
    </style>
</head>
<body>
<div class="app-container">
    <!-- header tabs -->
    <div class="header-tabs">
        <div class="tab active" data-view="home">Home</div>
        <div class="tab" data-view="bookmarks">Bookmarks</div>
        <div class="tab" data-view="progress">Progress</div>
    </div>

    <!-- Home View -->
    <div id="homeView" class="view active">
        <div class="categories" id="categoriesContainer"></div>
        <div class="random-block">
            <button class="random-btn" id="randomQuizBtn">ðŸŽ² RANDOM QUIZ</button>
        </div>
    </div>

    <!-- Bookmarks View -->
    <div id="bookmarksView" class="view">
        <h2 style="margin-bottom:20px;">ðŸ”– Bookmarked Questions</h2>
        <div id="bookmarksList"></div>
    </div>

    <!-- Progress View -->
    <div id="progressView" class="view">
        <h2 style="margin-bottom:20px;">ðŸ“Š Your Progress</h2>
        <div id="progressStats" class="stats-grid"></div>
    </div>

    <!-- Practice View (hidden initially, shown when starting a quiz) -->
    <div id="practiceView" class="view">
        <div class="practice-header">
            <div class="timer" id="timerDisplay">00:00</div>
            <button class="bookmark-star inactive" id="bookmarkToggle">â˜†</button>
            <button class="secondary-btn" id="exitPracticeBtn">Exit</button>
        </div>
        <div class="qbank-container" id="qbankContainer">
            <div class="question-sidebar" id="sidebar"></div>
            <div class="main-panel" id="mainPanel"></div>
        </div>
    </div>

    <!-- Modal for quiz setup -->
    <div id="setupModal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modalTitle">Setup Quiz</h3>
            <label>Number of questions:</label>
            <input type="number" id="questionCount" min="1" value="10">
            <div class="mode-option">
                <label><input type="radio" name="mode" value="normal" checked> Normal (with explanations)</label>
                <label><input type="radio" name="mode" value="exam"> Exam (timer, no explanations)</label>
            </div>
            <label>Time limit (minutes, exam mode only):</label>
            <input type="number" id="timerMinutes" min="1" value="60" disabled>
            <div class="modal-actions">
                <button class="modal-btn primary" id="startQuizBtn">Start</button>
                <button class="modal-btn secondary" id="cancelModalBtn">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    // ========== CONFIGURATION ==========
    // !! REPLACE WITH YOUR GITHUB INFO !!
    const GITHUB_USER = "Imran362-arch";
    const REPO_NAME = "IWORK";
    const BASE_URL = `https://raw.githubusercontent.com/${GITHUB_USER}/${REPO_NAME}/main/`;

    // Define categories and their JSON files (subtopics)
    const CONFIG = {
        categories: [
            {
                name: "Biochemistry",
                subtopics: [
                    { name: "Cellular & Molecular", file: "data/biochemistry/cell_molecular.json" },
                    // add more subtopics as needed
                ]
            },
            {
                name: "Microbiology",
                subtopics: [
                    { name: "Parasitology", file: "data/microbiology/parasitology.json" },
                    // add more subtopics as needed
                ]
            }
            // add more categories as needed
        ]
    };

    // ========== GLOBAL STATE ==========
    let allQuestions = [];               // array of { id, category, subtopic, data }
    let questionsMap = new Map();        // id -> question object
    let userAnswers = new Map();         // questionId -> selected choice id
    let submitted = new Map();           // questionId -> boolean
    let bookmarks = new Set();           // set of questionIds
    let currentPracticeSession = null;   // { questionIds, mode, timer, startTime, ... }
    let timerInterval = null;

    // Load from localStorage
    function loadStoredData() {
        try {
            const stored = JSON.parse(localStorage.getItem('uworld_qbank'));
            if (stored) {
                userAnswers = new Map(stored.userAnswers);
                submitted = new Map(stored.submitted);
                bookmarks = new Set(stored.bookmarks || []);
            }
        } catch (e) {}
    }
    function saveStoredData() {
        const data = {
            userAnswers: Array.from(userAnswers.entries()),
            submitted: Array.from(submitted.entries()),
            bookmarks: Array.from(bookmarks)
        };
        localStorage.setItem('uworld_qbank', JSON.stringify(data));
    }

    // ========== LOAD QUESTIONS ==========
    async function loadAllQuestions() {
        const promises = [];
        for (let cat of CONFIG.categories) {
            for (let sub of cat.subtopics) {
                const url = BASE_URL + sub.file;
                promises.push(
                    fetch(url)
                        .then(res => res.json())
                        .then(json => {
                            json.questions.forEach((q, idx) => {
                                const id = `${cat.name}_${sub.name}_${idx}`.replace(/\s+/g,'');
                                const fullQ = {
                                    id,
                                    category: cat.name,
                                    subtopic: sub.name,
                                    data: q
                                };
                                allQuestions.push(fullQ);
                                questionsMap.set(id, fullQ);
                            });
                        })
                        .catch(err => console.warn(`Failed to load ${sub.file}`, err))
                );
            }
        }
        await Promise.all(promises);
        renderHome();
        renderBookmarks();
        renderProgress();
    }

    // ========== RENDER HOME ==========
    function renderHome() {
        const container = document.getElementById('categoriesContainer');
        let html = '';
        for (let cat of CONFIG.categories) {
            html += `<div class="category-card"><div class="category-header">${cat.name}</div><div class="subtopics">`;
            for (let sub of cat.subtopics) {
                html += `<button class="subtopic-btn" data-category="${cat.name}" data-subtopic="${sub.name}">${sub.name}</button>`;
            }
            html += '</div></div>';
        }
        container.innerHTML = html;

        // Attach subtopic click handlers
        document.querySelectorAll('.subtopic-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const category = btn.dataset.category;
                const subtopic = btn.dataset.subtopic;
                const questions = allQuestions.filter(q => q.category === category && q.subtopic === subtopic);
                if (questions.length === 0) return alert('No questions available.');
                openSetupModal(questions.map(q => q.id));
            });
        });
    }

    // ========== MODAL ==========
    const modal = document.getElementById('setupModal');
    const modalTitle = document.getElementById('modalTitle');
    const questionCountInput = document.getElementById('questionCount');
    const modeRadios = document.getElementsByName('mode');
    const timerMinutesInput = document.getElementById('timerMinutes');
    let currentQuestionPool = []; // array of questionIds for this setup

    function openSetupModal(pool) {
        currentQuestionPool = pool;
        modalTitle.innerText = `Select from ${pool.length} questions`;
        questionCountInput.max = pool.length;
        questionCountInput.value = Math.min(10, pool.length);
        modal.classList.remove('hidden');
    }

    document.getElementById('randomQuizBtn').addEventListener('click', () => {
        if (allQuestions.length === 0) return alert('No questions loaded.');
        currentQuestionPool = allQuestions.map(q => q.id);
        modalTitle.innerText = `Random from all (${currentQuestionPool.length} avail)`;
        questionCountInput.max = currentQuestionPool.length;
        questionCountInput.value = Math.min(20, currentQuestionPool.length);
        modal.classList.remove('hidden');
    });

    document.getElementById('cancelModalBtn').addEventListener('click', () => {
        modal.classList.add('hidden');
    });

    modeRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            timerMinutesInput.disabled = (e.target.value !== 'exam');
        });
    });

    document.getElementById('startQuizBtn').addEventListener('click', () => {
        const count = parseInt(questionCountInput.value);
        if (count < 1 || count > currentQuestionPool.length) {
            alert(`Please enter a number between 1 and ${currentQuestionPool.length}`);
            return;
        }
        // random selection
        const shuffled = [...currentQuestionPool].sort(() => Math.random() - 0.5);
        const selectedIds = shuffled.slice(0, count);
        const mode = document.querySelector('input[name="mode"]:checked').value;
        const timerMinutes = mode === 'exam' ? parseInt(timerMinutesInput.value) : null;
        startPractice(selectedIds, mode, timerMinutes);
        modal.classList.add('hidden');
    });

    // ========== START PRACTICE ==========
    function startPractice(questionIds, mode, timerMinutes) {
        // stop any existing timer
        if (timerInterval) clearInterval(timerInterval);
        const questions = questionIds.map(id => questionsMap.get(id)).filter(q => q);
        if (questions.length === 0) return;

        currentPracticeSession = {
            questionIds,
            mode,
            timerMinutes,
            startTime: Date.now(),
            timeLeft: timerMinutes ? timerMinutes * 60 : null,
            currentIndex: 0,
            // we'll store answers in global userAnswers, not session-specific
        };

        // switch view
        document.querySelectorAll('.tab, .view').forEach(el => el.classList.remove('active'));
        document.getElementById('practiceView').classList.add('active');
        // hide header tabs during practice (optional)
        document.querySelector('.header-tabs').style.display = 'none';

        // render first question
        renderPractice();
        if (mode === 'exam') startTimer();
    }

    function startTimer() {
        if (!currentPracticeSession || currentPracticeSession.mode !== 'exam') return;
        timerInterval = setInterval(() => {
            if (!currentPracticeSession) return clearInterval(timerInterval);
            const elapsed = Math.floor((Date.now() - currentPracticeSession.startTime) / 1000);
            const total = currentPracticeSession.timerMinutes * 60;
            const left = total - elapsed;
            if (left <= 0) {
                clearInterval(timerInterval);
                // auto-submit? or just end? we'll submit whatever is answered
                alert('Time is up!');
                // optionally force end
            } else {
                currentPracticeSession.timeLeft = left;
                updateTimerDisplay();
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const left = currentPracticeSession?.timeLeft || 0;
        const mins = Math.floor(left / 60);
        const secs = left % 60;
        document.getElementById('timerDisplay').innerText = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
    }

    // ========== RENDER PRACTICE (sidebar + main) ==========
    function renderPractice() {
        if (!currentPracticeSession) return;
        const ids = currentPracticeSession.questionIds;
        const currentIdx = currentPracticeSession.currentIndex;
        const currentId = ids[currentIdx];
        const q = questionsMap.get(currentId);
        if (!q) return;

        // Sidebar
        const sidebar = document.getElementById('sidebar');
        let gridHtml = '<div class="question-grid">';
        for (let i = 0; i < ids.length; i++) {
            const id = ids[i];
            const statusClass = submitted.get(id) ? (userAnswers.get(id) === q.data.correct_choice_id ? 'answered-correct' : 'answered-incorrect') : '';
            const currentClass = (i === currentIdx) ? 'current' : '';
            gridHtml += `<div class="q-num-btn ${statusClass} ${currentClass}" data-qindex="${i}">${i+1}</div>`;
        }
        gridHtml += '</div><button class="reset-all" id="resetProgressBtn">Reset this quiz</button>';
        sidebar.innerHTML = gridHtml;

        // Main panel
        const main = document.getElementById('mainPanel');
        const isSubmitted = submitted.get(currentId) || false;
        const selectedId = userAnswers.get(currentId);
        const correctId = q.data.correct_choice_id;
        const letters = ['A','B','C','D','E','F'];

        let choicesHtml = '';
        q.data.choices.forEach((ch, idx) => {
            let choiceClass = 'choice-item';
            if (isSubmitted) choiceClass += ' disabled-choice';
            if (selectedId === ch.id) choiceClass += ' selected';
            if (isSubmitted && ch.id === correctId) choiceClass += ' correct-choice';
            if (isSubmitted && selectedId === ch.id && selectedId !== correctId) choiceClass += ' incorrect-selected';
            choicesHtml += `
                <div class="${choiceClass}" data-choice-id="${ch.id}">
                    <span class="choice-letter">${letters[idx]}</span>
                    <span class="choice-text">${ch.text}</span>
                </div>
            `;
        });

        const resultBadge = isSubmitted ? (selectedId === correctId ? '<span class="result-badge" style="background:#1e7640;">âœ“ correct</span>' : '<span class="result-badge" style="background:#b13e3e;">âœ— incorrect</span>') : '';

        let explanationHtml = '';
        if (isSubmitted && currentPracticeSession.mode !== 'exam') {
            explanationHtml = `<div class="explanation-panel"><h3>ðŸ“˜ Explanation ${resultBadge}</h3><div class="explanation-content">${q.data.solution}</div></div>`;
        }

        const mainHtml = `
            <div class="top-bar">
                <div class="q-counter">Question ${currentIdx+1} / ${ids.length}</div>
                <div class="nav-buttons">
                    <button class="nav-btn" id="prevBtn" ${currentIdx===0?'disabled':''}>â—€ Prev</button>
                    <button class="nav-btn" id="nextBtn" ${currentIdx===ids.length-1?'disabled':''}>Next â–¶</button>
                </div>
            </div>
            <div class="question-card">
                <div class="question-text">${q.data.text}</div>
                <div class="choices-container">${choicesHtml}</div>
                <div class="action-buttons">
                    <button class="primary-btn" id="submitBtn" ${isSubmitted?'disabled':''}>Submit</button>
                    <button class="secondary-btn" id="clearBtn" ${!isSubmitted?'disabled':''}>Reset answer</button>
                </div>
                ${explanationHtml}
            </div>
            <footer>${q.category} Â· ${q.subtopic}</footer>
        `;
        main.innerHTML = mainHtml;

        // Bookmark star update
        const bookmarkToggle = document.getElementById('bookmarkToggle');
        bookmarkToggle.innerText = bookmarks.has(currentId) ? 'â˜…' : 'â˜†';
        bookmarkToggle.classList.toggle('active', bookmarks.has(currentId));
        bookmarkToggle.classList.toggle('inactive', !bookmarks.has(currentId));

        // Event listeners
        if (!isSubmitted) {
            document.querySelectorAll('.choice-item').forEach(el => {
                el.addEventListener('click', () => {
                    document.querySelectorAll('.choice-item').forEach(c => c.classList.remove('selected'));
                    el.classList.add('selected');
                });
            });
        }

        document.getElementById('submitBtn')?.addEventListener('click', () => {
            const selectedEl = document.querySelector('.choice-item.selected');
            if (!selectedEl) return alert('Select an answer');
            const chosenId = parseInt(selectedEl.dataset.choiceId);
            userAnswers.set(currentId, chosenId);
            submitted.set(currentId, true);
            saveStoredData();
            renderPractice();
        });

        document.getElementById('clearBtn')?.addEventListener('click', () => {
            userAnswers.delete(currentId);
            submitted.delete(currentId);
            saveStoredData();
            renderPractice();
        });

        document.getElementById('prevBtn')?.addEventListener('click', () => {
            if (currentIdx > 0) {
                currentPracticeSession.currentIndex--;
                renderPractice();
            }
        });
        document.getElementById('nextBtn')?.addEventListener('click', () => {
            if (currentIdx < ids.length-1) {
                currentPracticeSession.currentIndex++;
                renderPractice();
            }
        });

        // sidebar question clicks
        document.querySelectorAll('.q-num-btn[data-qindex]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const idx = parseInt(e.currentTarget.dataset.qindex);
                if (!isNaN(idx) && idx !== currentIdx) {
                    currentPracticeSession.currentIndex = idx;
                    renderPractice();
                }
            });
        });

        document.getElementById('resetProgressBtn')?.addEventListener('click', () => {
            if (confirm('Reset all answers for this quiz?')) {
                ids.forEach(id => {
                    userAnswers.delete(id);
                    submitted.delete(id);
                });
                saveStoredData();
                renderPractice();
            }
        });
    }

    // ========== BOOKMARKS ==========
    function renderBookmarks() {
        const listDiv = document.getElementById('bookmarksList');
        if (bookmarks.size === 0) {
            listDiv.innerHTML = '<p>No bookmarks yet. Star questions during practice.</p>';
            return;
        }
        let html = '';
        bookmarks.forEach(id => {
            const q = questionsMap.get(id);
            if (!q) return;
            html += `<div class="bookmark-item" data-id="${id}">
                <strong>${q.category} Â· ${q.subtopic}</strong><br>
                <small>${q.data.text.substring(0,100)}...</small>
            </div>`;
        });
        listDiv.innerHTML = html;
        document.querySelectorAll('.bookmark-item').forEach(el => {
            el.addEventListener('click', () => {
                // start a single-question practice
                startPractice([el.dataset.id], 'normal', null);
            });
        });
    }

    document.getElementById('bookmarkToggle')?.addEventListener('click', () => {
        if (!currentPracticeSession) return;
        const currentId = currentPracticeSession.questionIds[currentPracticeSession.currentIndex];
        if (bookmarks.has(currentId)) {
            bookmarks.delete(currentId);
        } else {
            bookmarks.add(currentId);
        }
        saveStoredData();
        renderPractice(); // updates star
    });

    // ========== PROGRESS ==========
    function renderProgress() {
        const statsDiv = document.getElementById('progressStats');
        const categories = {};
        allQuestions.forEach(q => {
            if (!categories[q.category]) categories[q.category] = { total:0, attempted:0, correct:0 };
            categories[q.category].total++;
            if (submitted.get(q.id)) {
                categories[q.category].attempted++;
                if (userAnswers.get(q.id) === q.data.correct_choice_id) categories[q.category].correct++;
            }
        });
        let html = '';
        for (let cat in categories) {
            const c = categories[cat];
            html += `<div class="stat-card">
                <h4>${cat}</h4>
                <p>Attempted: ${c.attempted}/${c.total}</p>
                <p>Correct: ${c.correct}</p>
                <p>Accuracy: ${c.attempted ? ((c.correct/c.attempted)*100).toFixed(1) : 0}%</p>
            </div>`;
        }
        statsDiv.innerHTML = html || '<p>No data yet.</p>';
    }

    // ========== TAB NAVIGATION ==========
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const viewName = tab.dataset.view;
            document.querySelectorAll('.tab, .view').forEach(el => el.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(viewName + 'View').classList.add('active');
            if (viewName === 'bookmarks') renderBookmarks();
            if (viewName === 'progress') renderProgress();
        });
    });

    document.getElementById('exitPracticeBtn').addEventListener('click', () => {
        if (timerInterval) clearInterval(timerInterval);
        currentPracticeSession = null;
        document.querySelector('.header-tabs').style.display = 'flex';
        document.querySelectorAll('.tab, .view').forEach(el => el.classList.remove('active'));
        document.querySelector('.tab[data-view="home"]').classList.add('active');
        document.getElementById('homeView').classList.add('active');
    });

    // ========== INIT ==========
    loadStoredData();
    loadAllQuestions();
})();
</script>
</body>
</html>
